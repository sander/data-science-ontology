name: Validate and publish

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      IPFS_DEPLOY_CLOUDFLARE__API_EMAIL: ${{ secrets.IPFS_DEPLOY_CLOUDFLARE__API_EMAIL }}
      IPFS_DEPLOY_CLOUDFLARE__API_KEY: ${{ secrets.IPFS_DEPLOY_CLOUDFLARE__API_KEY }}
      IPFS_DEPLOY_CLOUDFLARE__ZONE: sanderdijkhuis.nl
      IPFS_DEPLOY_CLOUDFLARE__RECORD: _dnslink.data-science-ontology.sanderdijkhuis.nl
    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-java@v1
      with:
        java-version: "9.0.4"
    - uses: DeLaGuardo/setup-clojure@2.0
      with:
        tools-deps: "1.10.1.469"
    - name: Install Pandoc 2.6
      run: |
        wget https://github.com/jgm/pandoc/releases/download/2.6/pandoc-2.6-1-amd64.deb
        sudo dpkg -i pandoc-2.6-1-amd64.deb
    - name: Use Node.js 12.x
      uses: actions/setup-node@v1
      with:
        node-version: 12.x
    - name: Build and validate documents
      run: |
        npm ci
        npm run build
        npm run validate
      env:
        LANG: en_US.UTF-8
        CI: true
    - name: Build JSON-LD
      run: |
        clojure -Sdeps "{:deps {ontology-linker {:git/url \"https://github.com/sander/ontology-linker\" :sha \"dc2ed488529098b44806da8dad5b5691b1b31ae5\"}}}" \
          -e "(use 'nl.sanderdijkhuis.ontology.next) (build-linked-data! \"/home/runner/work/data-science-ontology/data-science-ontology/build\" \"/home/runner/work/data-science-ontology/data-science-ontology/json-ld\")"
    - run: |
        echo IPFS_DEPLOY_CLOUDFLARE__API_EMAIL=$IPFS_DEPLOY_CLOUDFLARE__API_EMAIL >> .env
        echo IPFS_DEPLOY_CLOUDFLARE__API_KEY=$IPFS_DEPLOY_CLOUDFLARE__API_KEY >> .env
        echo IPFS_DEPLOY_CLOUDFLARE__API_ZONE=$IPFS_DEPLOY_CLOUDFLARE__API_ZONE >> .env
        echo IPFS_DEPLOY_CLOUDFLARE__API_RECORD=$IPFS_DEPLOY_CLOUDFLARE__API_RECORD >> .env
        npx ipfs-deploy -d cloudflare ~/work/data-science-ontology/data-science-ontology/json-ld
